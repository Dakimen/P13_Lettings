# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: CI/CD/Deploy

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.8
        uses: actions/setup-python@v3
        with:
          python-version: "3.8"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Lint with flake8
        run: |
          flake8 . --count --max-line-length=99 --statistics
      - name: Test with pytest
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          pytest \
            --cov=lettings \
            --cov=profiles \
            --cov=oc_lettings_site \
            --cov-fail-under=80

  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Yandex Container Registry
        uses: docker/login-action@v3
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YANDEX_SA_KEY }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/orange-lettings:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/orange-lettings:${{ github.sha }}
            ${{ secrets.YANDEX_CR }}/orange-lettings:latest

  deploy:
    needs: cd
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Authenticate to Yandex Cloud
        run: |
          echo '${{ secrets.YANDEX_SA_KEY }}' > key.json
          yc config set service-account-key key.json
          yc config set cloud-id ${{ secrets.YANDEX_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YANDEX_FOLDER_ID }}
          rm -f key.json

      - name: Deploy new container revision
        run: |
          yc serverless container revision deploy \
            --container-id ${{ secrets.CONTAINER_ID }} \
            --image ${{ secrets.YANDEX_CR }}/orange-lettings:latest \
            --service-account-id ${{ secrets.SA_ID }} \
            --memory 512M \
            --execution-timeout 10s \
            --concurrency 1
